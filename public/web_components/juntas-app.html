<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<link rel="import" href="/iron-media-query/iron-media-query.html">
<link rel="import" href="/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="/iron-scroll-target-behavior/iron-scroll-target-behavior.html">
<link rel="import" href="/iron-location/iron-location.html">
<link rel="import" href="/iron-location/iron-query-params.html">
<link rel="import" href="/iron-meta/iron-meta.html"> 

<link rel="import" href="/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="/iron-localstorage/iron-localstorage.html">
<link rel="import" href="/iron-selector/iron-selector.html">
<link rel="import" href="/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="/iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="/paper-ripple/paper-ripple.html">
<link rel="import" href="/iron-list/iron-list.html">
<link rel="import" href="/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="/webrtc-peer/webrtc-peer.html">
<link rel="import" href="/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/app-route/app-route.html">
<link rel="import" href="/app-route/app-location.html">
<link rel="import" href="/app-route/app-route-converter.html">
<link rel="import" href="/iron-icon/iron-icon.html">
<link rel="import" href="/iron-pages/iron-pages.html">
<link rel="import" href="/iron-behaviors/iron-button-state.html">
<link rel="import" href="/iron-behaviors/iron-control-state.html">
<link rel="import" href="/iron-checked-element-behavior/iron-checked-element-behavior.html">
<link rel="import" href="/paper-styles/paper-styles.html">
<link rel="import" href="/iron-ajax/iron-ajax.html">
<link rel="import" href="/iron-image/iron-image.html">
<link rel="import" href="/paper-input/paper-input.html">
<link rel="import" href="/paper-spinner/paper-spinner.html">
<link rel="import" href="/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/paper-material/paper-material.html">
<link rel="import" href="/app-layout/app-layout.html">
<link rel="import" href="/paper-behaviors/paper-button-behavior.html">
<link rel="import" href="/paper-behaviors/paper-checked-element-behavior.html">
<link rel="import" href="/paper-behaviors/paper-inky-focus-behavior.html">
<link rel="import" href="/paper-card/paper-card.html">
<link rel="import" href="/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/paper-icon-button/paper-icon-button-light.html">


<link rel="import" href="/facebook-login/facebook-login.html">
<link rel="import" href="/google-signin/google-signin.html">
<link rel="import" href="/google-youtube/google-youtube.html">
<link rel="import" href="/iron-flex-layout/iron-flex-layout-classes.html">

<!--<link rel="import" href="/neon-animations/neon-animated-pages.html">-->
<!--<link rel="import" href="/neon-animations/neon-animations.html">-->
<link rel="import" href="/web_components/paper-input-autocomplete.html">
<link rel="import" href="/web_components/juntas-head.html">
<link rel="import" href="/web_components/juntas-block.html">
<dom-module id="juntas-app">
	<template>
		<style>
			:host {
    --app-primary-color: #4285f4;
    --app-secondary-color: black;
    display: block;
}

iron-image {
    fill: var(--icon-toggle-color, rgba(0, 0, 0, 0));
    stroke: var(--icon-toggle-outline-color, currentcolor);
}

paper-card .header {
    height: 225px !important;
}

app-header {
    color: #fff;
    background-color: var(--app-primary-color);
    position: fixed;
    z-index: 2000;
    width: 100%;
}

    app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
    }

.drawer-list {
    margin: 0 20px;
}

    .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
    }

.loadingIndicator {
    font-size: 16px;
    text-align: center;
    height: 60px;
}

    .loadingIndicator paper-spinner {
        margin-right: 20px;
        vertical-align: middle;
    }

.drawer-list a.iron-selected {
    color: black;
    font-weight: bold;
}

.searchInput {
    @apply(--layout-flex);
    font-size: 18px;
    padding: 10px 20px;
    border: none;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    -webkit-appearance: none;
    border-radius: 0px;
}

    .searchInput:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }

    .searchInput:focus {
        background-color: white;
        outline: none;
        color: black;
    }

.loadingIndicator {
    font-size: 16px;
    text-align: center;
    height: 60px;
}

    .loadingIndicator paper-spinner {
        margin-right: 20px;
        vertical-align: middle;
    }

.card-content {
    @apply(--layout);
    background-color: rgba(207, 253, 129, 0.26);
    font-size: 16px;
}

iron-list {
    margin-top: 90px;
    padding-bottom: 16px;
}

paper-card {
    margin-right: 5px;
    margin-left: 5px;
}

.photoContent {
    @apply(--layout);
    background-color: #ddd;
    position: relative;
    width: 300px;
    height: 300px;
    margin: 8px;
}

    .photoContent:hover .detail {
        opacity: 1;
    }

    .photoContent > iron-image {
        @apply(--layout-flex);
    }

    .photoContent > .detail {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.8) 100%);
        color: white;
        font-size: 20px;
        font-weight: 100;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.1s;
    }

paper-card .header,
.header {
    height: 169px;
}

.header {
    height: 225px;
}

.img-rounded {
    border-radius: 6px;
}

		</style>
		<style is="custom-style">
			paper-card.white {
				--paper-card-header-color: #fff;
			}
			
			paper-card .header iron-image {
				height: 169px;
			}
			
			paper-card .header {
				height: 169px;
			}
			
			paper-input-autocomplete {
				width: 100%;
			}
			
			.header {
				height: 225px;
			}
			
			iron-image,
			iron-image /deep/ img {
				display: block;
				width: 100%;
			}
			
			.preload iron-image {
				width: 150px;
				height: 150px;
				background: #ddd;
			}
		</style>




		 
		<juntas-head settings="[[settingsx]]"></juntas-head>



		<iron-ajax id="ajax" loading="{{loadingData}}" url="[[_loadItems(searchText, page)]]" params='{"order":"1"}' handle-as="json"
			on-response="_didReceiveResponse"></iron-ajax>
		<iron-ajax id="metaAjax" method="GET" auto loading="{{searchInput.value}}" params='[[_getMetaParams(_loadMetaBody)]]' url="[[_loadMetaUrl]]"
			handle-as="json" on-response="_selectSearchItem"></iron-ajax>


		<!--<template is="dom-repeat" items="[[items]]">
			<!--<div class="horizontal-section">
				<juntas-block item="[[item]]"></juntas-block>
			</div> 
		

		</template>-->


		<iron-list items="[[items]]" as="item" grid id="ItemList" scroll-target="document" style="height: 400px">
			<template>

				<div class="horizontal-section">
					<juntas-block item="[[item]]"></juntas-block>
				</div>
			</template>
		</iron-list>
		<div class="loadingIndicator" hidden$="[[!loadingData]]">
			<paper-spinner active$="[[loadingData]]"></paper-spinner> Fetching photos for <b>[[searchText]]</b>
		</div>
		<iron-scroll-threshold lower-threshold="300" id="scrollThreshold" scroll-target="document" on-lower-threshold="_onLowerThreshold">
		</iron-scroll-threshold>
		<iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>
		<iron-media-query full query="print" query-matches="{{print}}"></iron-media-query>
		<iron-media-query id="mquery" query="{min-width: 600px}"></iron-media-query>
	</template>
	<script>
        Polymer({
    is: 'juntas-app',
    properties: {
        items: {
            type: Array,
            value: [],
            notify: true
        },
        perPage: {
            type: Number,
            value: 100
        },
        searchPlaceholder: {
            type: String,
            notify: true
        },

        _loadMetaUrl: {
            type: String,
            notify: true
        },

        _loadMetaBody: {
            type: String,
            notify: true
        },


        page: {
            type: Number,
            value: 0
        },

        searchText: {
            type: String,
            value: ''
        },
        history: { type: Array, value: [] },
        alldata: { users: {}, metadata: {}, tabs: {} },
        loadingData: Boolean
    },
    ready: function () {
        if (window.APPINIT)
            return;


        // toggle fixed header based on screen size
        var _this = this;
        //this.alldata = { users: {}, metadata: {}, tabs: {} };
       // this._loadMetaUrl = '/tabs/metadata';
        var pendingNotification = null;
         
        this.socket = io({secure: true});
        user = this._getAnonimusUser();
        this.socket.emit('juntas connect', { UserId: user._id, ano: true });




        this.socket.on('public tab navigate', (navData) => {
            var Map = navData.Map;
            Map.videoId = this._youTubeGetID(Map.Url);
            Map.autoPlay = 1;
            Map.tab = _this.properties.alldata.tabs[Map.TabId];
            Map.user = _this.properties.alldata.users[Map.UserId];

            _this.unshift('items', Map);
            _this.$.scrollThreshold.clearTriggers();
            _this.$.ItemList.fire('iron-resize');
            window.dispatchEvent(new Event('resize'));
            var options = {
                body: Map.Title,
                icon: Map.Thumb
            }

            function validateImage(thumb, bad, good) {
                var img = new Image();
                img.onload = good;
                img.onerror = bad;
                img.src = Map.Thumb;

            }
            function good() {
                Notification.requestPermission().then(function (result) {
                    var n = new Notification(Map.Title, options);
                });

            }
            function bad() {
                setTimeout(function () {
                    validateImage(Map.Thumb, bad, good);
                }, 500);
            }
            validateImage(Map.Thumb, bad, good);
        });
        window.APPINIT = true;

        // socket.on('chat message', function (msg) {
        //     var shadow = document.createElement('paper-shadow');
        //     shadow.innerHTML = msg;
        //     messagesList.appendChild(shadow);
        // });


    },
    observers: [
        '_routePageChanged(routeData.page)'
    ],

    _routePageChanged: function (page) {
        this.page = page || 0;
    },
    _youTubeGetID: function (url) {
        var ID = '';
        url = url.replace(/(>|<)/gi, '').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
        if (url[2] !== undefined) {
            ID = url[2].split(/[^0-9a-z_\-]/i);
            ID = ID[0];
        }
        else {
            ID = undefined;
        }
        return ID;
    },

    _didReceiveResponse: function (e) {
        var payload = e.detail.response;

        var _this = this;
        payload.users.map(function (user) {
            _this.properties.alldata.users[user._id] = user;
        });
        payload.metadata.map(function (meta) {
            _this.properties.alldata.metadata[meta._id] = meta;
        });
        payload.tabs.map(function (tab) {
            _this.properties.alldata.tabs[tab._id] = tab;
        });





        for (var i = 0; i < payload.history.length; i++) {

            payload.history[i].videoId = this._youTubeGetID(payload.history[i].Url);
            payload.history[i].autoPlay = 1;
            payload.history[i].tab = _this.properties.alldata.tabs[payload.history[i].TabId];
            payload.history[i].user = _this.properties.alldata.users[payload.history[i].UserId];
            // _this.properties.items.value.push(payload.history[i]);
            _this.push('items', payload.history[i]);

            // _this.$.ItemList.push('items', payload.history[i]);

        }


        this.$.scrollThreshold.clearTriggers();

    },
    _onLowerThreshold: function () {

        // this.$.scrollThreshold.clearTriggers();
        this.debounce('_loadItems', this._loadMoreItems, 60);
    },

    _getAnonimusUser() {
        if (this.user)
            return this.user;
        else {
            var user = localStorage.getItem("anonimusjuntasuser");
            if (user !== null) {
                user = JSON.parse(user);
            }
            else {
                user = { _id: guid() }
                localStorage.setItem("anonimusjuntasuser", JSON.stringify(user));
            }
            this.user = user;
            return user;
        }
    },

    _loadMoreItems: function () {
        this.page++;
        this.$.ajax.generateRequest();
    },

    _loadItems: function (term, page) {

        return '/content/latestItems/' + page;
    },

    _loadSearchItems: function (term, page) {
        return '/content/websearch?Name=' + term + '&sensor=false';
    },


    _getMetaParams: function (url) {
        return { 'url': url };
    },
    _selectSearchItem: function (e) {
        var item = e.detail.response;

        //this._loadMetaBody = item.Url;
        // $item.Map = $item;
        // $http.post('/tabs/metadata', {
        //     url: $item.Url
        // }).then(function (response) {

        //     $scope.latestHistoryOrig = angular.copy($scope.latestHistory);
        //     $scope.latestHistory = [];
        //     $item.Meta = response.data;
        //     $item.fromSearch = true;
        //     $scope.appendItem($item);
        // });

    },

    _pageChanged: function (page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl('my-' + page + '.html');
        this.importHref(resolvedPageUrl, null, this._showPage404, true);
    },

    _showPage404: function () {
        this.page = 'view404';
    }




});


function S4() {
    return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
}

function guid() {
    guid = (S4() + S4() + "-" + S4() + "-4" + S4().substr(0, 3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
    return guid;
}


    </script>
</dom-module>